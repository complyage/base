package verify

//||------------------------------------------------------------------------------------------------||
//|| Import
//||------------------------------------------------------------------------------------------------||

import (
	"encoding/json"
	"fmt"

	"github.com/ralphferrara/aria/db"
	"github.com/ralphferrara/aria/storage"
)

//||------------------------------------------------------------------------------------------------||
//|| Load: load a Verification from storage by UUID
//||------------------------------------------------------------------------------------------------||

func Load(d *db.GormWrapper, s *storage.Storage, uuid string, privateKey string, publicKey string) (Verification, error) {
	//||------------------------------------------------------------------------------------------------||
	//|| Validate
	//||------------------------------------------------------------------------------------------------||
	if uuid == "" {
		return Verification{}, fmt.Errorf("uuid is empty")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| V
	//||------------------------------------------------------------------------------------------------||
	v := Verification{}
	v.UUID = uuid
	//||------------------------------------------------------------------------------------------------||
	//|| Fetch Verification JSON
	//||------------------------------------------------------------------------------------------------||
	data, err := s.Get(v.ObjectName(false))
	if err != nil {
		return Verification{}, fmt.Errorf("get %q failed: %w", v.ObjectName(false), err)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Unmarshal
	//||------------------------------------------------------------------------------------------------||
	if err := json.Unmarshal(data, &v); err != nil {
		return Verification{}, fmt.Errorf("unmarshal %q failed: %w", v.ObjectName(false), err)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Storage
	//||------------------------------------------------------------------------------------------------||
	v.Database = d
	v.Storage = *s
	v.Keys = PrivatePublic{
		Private: privateKey,
		Public:  publicKey,
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Done
	//||------------------------------------------------------------------------------------------------||
	return v, nil
}
