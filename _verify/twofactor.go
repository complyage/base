package verify

import (
	"fmt"
	"time"

	"github.com/ralphferrara/aria/app"
	"github.com/ralphferrara/aria/base/random"
)

//||------------------------------------------------------------------------------------------------||
//|| Transaction
//||------------------------------------------------------------------------------------------------||

type TwoFactor struct {
	Timestamp  time.Time `json:"timestamp"`
	Expiration time.Time `json:"expiration"`
	Attempts   int       `json:"attempts"`
	Code       string    `json:"code"`
}

//||------------------------------------------------------------------------------------------------||
//|| Initialize Two-Factor Verification
//||------------------------------------------------------------------------------------------------||

func (v *Verification) TwoFactorInit() error {
	//||------------------------------------------------------------------------------------------------||
	//|| Check
	//||------------------------------------------------------------------------------------------------||
	if v.Type != DataTypeCRCD && v.Type != DataTypePHNE && v.Type != DataTypeADDR && v.Type != DataTypeMAIL {
		fmt.Println("TwoFactorInit: Not a type that requires two-factor:", v.Type)
		return nil
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Expires Time
	//||------------------------------------------------------------------------------------------------||
	expirMin := 15
	if v.Type == DataTypeADDR {
		expirMin = 60 * 60 * 24 * 30
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Code
	//||------------------------------------------------------------------------------------------------||
	code := random.NumberString(6)
	//||------------------------------------------------------------------------------------------------||
	//|| Initialize Two-Factor Verification
	//||------------------------------------------------------------------------------------------------||
	v.TwoFactor = TwoFactor{
		Timestamp:  time.Now().UTC(),
		Expiration: time.Now().Add(time.Minute * time.Duration(expirMin)),
		Attempts:   0,
		Code:       string(code),
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Done
	//||------------------------------------------------------------------------------------------------||
	return nil
}

//||------------------------------------------------------------------------------------------------||
//|| Verify Two-Factor Code
//||------------------------------------------------------------------------------------------------||

func (v *Verification) TwoFactorVerify(code string) error {
	LogInfo("TwoFactor Verify Attempt")
	//||------------------------------------------------------------------------------------------------||
	//|| Check
	//||------------------------------------------------------------------------------------------------||
	if v.Type != DataTypeCRCD && v.Type != DataTypePHNE && v.Type != DataTypeADDR && v.Type != DataTypeMAIL {
		return nil
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Expired
	//||------------------------------------------------------------------------------------------------||
	expirationTime := v.TwoFactor.Expiration
	if !expirationTime.IsZero() && time.Now().UTC().After(expirationTime) {
		v.UpdateStatusExpired()
		return fmt.Errorf("verification code expired")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Attempts
	//||------------------------------------------------------------------------------------------------||
	if v.TwoFactor.Attempts > 5 {
		v.UpdateStatusReject("TWOFACTOR", app.Err("verify").Get("2FA_TOO_MANY"))
		return fmt.Errorf("too many attempts")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Check Code
	//||------------------------------------------------------------------------------------------------||
	if v.TwoFactor.Code == "" {
		return fmt.Errorf("twoFactor code was not set")
	}
	if v.TwoFactor.Code != code {
		v.TwoFactor.Attempts = v.TwoFactor.Attempts + 1
		v.Save()
		return fmt.Errorf("invalid code")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Success - Update Status
	//||------------------------------------------------------------------------------------------------||
	upErr := v.UpdateStatusVerified("TWOFACTOR")
	if upErr != nil {
		return upErr
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Done
	//||------------------------------------------------------------------------------------------------||
	return nil
}
