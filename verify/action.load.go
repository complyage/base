package verify

//||------------------------------------------------------------------------------------------------||
//|| Import
//||------------------------------------------------------------------------------------------------||

import (
	"encoding/json"

	"github.com/ralphferrara/aria/app"
)

//||------------------------------------------------------------------------------------------------||
//|| Load: load a Verification from storage by UUID
//||------------------------------------------------------------------------------------------------||

func Load(uuid string) (Verification, error) {
	//||------------------------------------------------------------------------------------------------||
	//|| Validate
	//||------------------------------------------------------------------------------------------------||
	if uuid == "" {
		return Verification{}, app.Err("Verify").Error("VERIFY_LOAD_UUID")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| V
	//||------------------------------------------------------------------------------------------------||
	v := Verification{}
	v.UUID = uuid
	//||------------------------------------------------------------------------------------------------||
	//|| Fetch Verification JSON
	//||------------------------------------------------------------------------------------------------||
	data, err := Storage.Get(v.Filename())
	if err != nil {
		return Verification{}, app.Err("Verify").Error("VERIFY_LOAD_FAILED")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Unmarshal
	//||------------------------------------------------------------------------------------------------||
	if err := json.Unmarshal(data, &v); err != nil {
		return Verification{}, app.Err("Verify").Error("VERIFY_LOAD_UNMARSHAL")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Done
	//||------------------------------------------------------------------------------------------------||
	return v, nil
}

//||------------------------------------------------------------------------------------------------||
//|| CheckLoad
//||------------------------------------------------------------------------------------------------||

func CheckLoad(uuid string, fidAccount int64) (Verification, error) {
	v, err := Load(uuid)
	if err != nil {
		app.Log.Error(err.Error())
		return Verification{}, err
	}
	if v.Account.ID != fidAccount {
		app.Log.Error("Account ID mismatch on verification load")
		return Verification{}, app.Err("Verify").Error("VERIFY_LOAD_ACCOUNT_MISMATCH")
	}
	return v, nil
}
