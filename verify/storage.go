package verify

//||------------------------------------------------------------------------------------------------||
//|| Import
//||------------------------------------------------------------------------------------------------||

import (
	"encoding/json"
	"fmt"

	"github.com/ralphferrara/aria/base/encrypt"
)

//||------------------------------------------------------------------------------------------------||
//|| object
//||------------------------------------------------------------------------------------------------||

func (v *Verification) ObjectName(encrypt bool) string {
	if encrypt {
		return v.UUID + ".encrypted.json"
	}
	return v.UUID + ".json"
}

//||------------------------------------------------------------------------------------------------||
//|| Save: persist a Verification to storage as <uuid>.json
//||------------------------------------------------------------------------------------------------||

func (v *Verification) Save() error {
	//||------------------------------------------------------------------------------------------------||
	//|| Validate
	//||------------------------------------------------------------------------------------------------||
	if v == nil {
		return fmt.Errorf("verification is nil")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Touch updated timestamp
	//||------------------------------------------------------------------------------------------------||
	v.Updated()
	//||------------------------------------------------------------------------------------------------||
	//|| Serialize
	//||------------------------------------------------------------------------------------------------||
	var data []byte
	var dErr error
	data, dErr = json.MarshalIndent(v, "", "  ")
	if dErr != nil {
		return fmt.Errorf("marshal verification failed: %w", dErr)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Store
	//||------------------------------------------------------------------------------------------------||
	if err := v.Storage.Put(v.ObjectName(false), data); err != nil {
		return fmt.Errorf("put %q failed: %w", v.ObjectName(false), err)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Done
	//||------------------------------------------------------------------------------------------------||
	return nil
}

//||------------------------------------------------------------------------------------------------||
//|| Finalize and persist a Verification to storage as <uuid>.json
//||------------------------------------------------------------------------------------------------||

func (v *Verification) Finalize() error {
	//||------------------------------------------------------------------------------------------------||
	//|| Validate
	//||------------------------------------------------------------------------------------------------||
	if v == nil {
		return fmt.Errorf("verification is nil")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Touch updated timestamp
	//||------------------------------------------------------------------------------------------------||
	v.Updated()
	//||------------------------------------------------------------------------------------------------||
	//|| Serialize
	//||------------------------------------------------------------------------------------------------||
	var data []byte
	var dErr error
	data, dErr = json.MarshalIndent(v.AsComplete(), "", "  ")
	if dErr != nil {
		return fmt.Errorf("marshal verification failed: %w", dErr)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Store
	//||------------------------------------------------------------------------------------------------||
	if err := v.Storage.Put(v.ObjectName(false), data); err != nil {
		return fmt.Errorf("put %q failed: %w", v.ObjectName(false), err)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Done
	//||------------------------------------------------------------------------------------------------||
	return nil
}

//||------------------------------------------------------------------------------------------------||
//|| Delete Main Data
//||------------------------------------------------------------------------------------------------||

func (v *Verification) Delete() error {
	//||------------------------------------------------------------------------------------------------||
	//|| Base Check
	//||------------------------------------------------------------------------------------------------||
	if v == nil {
		return fmt.Errorf("verification is nil")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Store
	//||------------------------------------------------------------------------------------------------||
	errMain := v.Storage.Delete(v.ObjectName(false))
	//||------------------------------------------------------------------------------------------------||
	//|| Failed
	//||------------------------------------------------------------------------------------------------||
	if errMain != nil {
		return fmt.Errorf("delete %q failed: %w", v.ObjectName(false), errMain)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Success
	//||------------------------------------------------------------------------------------------------||
	return nil
}

//||------------------------------------------------------------------------------------------------||
//|| Delete Encrypted Data
//||------------------------------------------------------------------------------------------------||

func (v *Verification) DeleteEncrypted() error {
	//||------------------------------------------------------------------------------------------------||
	//|| Store
	//||------------------------------------------------------------------------------------------------||
	errEnc := v.Storage.Delete(v.ObjectName(true))
	//||------------------------------------------------------------------------------------------------||
	//|| Failed
	//||------------------------------------------------------------------------------------------------||
	if errEnc != nil {
		return fmt.Errorf("delete %q failed: %w", v.ObjectName(true), errEnc)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Success
	//||------------------------------------------------------------------------------------------------||
	return nil
}

//||------------------------------------------------------------------------------------------------||
//|| Load the Encrypted Data
//||------------------------------------------------------------------------------------------------||

func (v *Verification) LoadEncrypted() error {
	//||------------------------------------------------------------------------------------------------||
	//|| Validate
	//||------------------------------------------------------------------------------------------------||
	if v.Keys.Private == "" {
		return fmt.Errorf("private key is empty")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Fetch Verification JSON
	//||------------------------------------------------------------------------------------------------||
	rawData, err := v.Storage.Get(v.ObjectName(true))
	if err != nil {
		return fmt.Errorf("get %q failed: %w", v.ObjectName(true), err)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Decrypt Data
	//||------------------------------------------------------------------------------------------------||
	decryptedData, err := encrypt.DecryptWithPrivateKey(rawData, v.Keys.Private)
	//||------------------------------------------------------------------------------------------------||
	//|| Unmarshal
	//||------------------------------------------------------------------------------------------------||
	err = json.Unmarshal(decryptedData, &v.Encrypted)
	if err != nil {
		return fmt.Errorf("unmarshal %q failed: %w", v.ObjectName(true), err)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Done
	//||------------------------------------------------------------------------------------------------||
	return nil
}

//||------------------------------------------------------------------------------------------------||
//|| Save: persist a Verification to storage as <uuid>.json
//||------------------------------------------------------------------------------------------------||

func (v *Verification) SaveEncrypted() error {
	//||------------------------------------------------------------------------------------------------||
	//|| Validate
	//||------------------------------------------------------------------------------------------------||
	if v == nil {
		return fmt.Errorf("verification is nil")
	}
	if v.Keys.Public == "" {
		return fmt.Errorf("Public key is empty")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Touch updated timestamp
	//||------------------------------------------------------------------------------------------------||
	v.Updated()
	//||------------------------------------------------------------------------------------------------||
	//|| Serialize
	//||------------------------------------------------------------------------------------------------||
	data, err := json.MarshalIndent(v, "", "  ")
	if err != nil {
		return fmt.Errorf("marshal verification failed: %w", err)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Encrypt
	//||------------------------------------------------------------------------------------------------||
	encryptedData, err := encrypt.EncryptWithPublicKey(data, v.Keys.Public)
	if err != nil {
		return fmt.Errorf("encrypt verification failed: %w", err)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Store
	//||------------------------------------------------------------------------------------------------||
	if err := v.Storage.Put(v.ObjectName(true), encryptedData); err != nil {
		return fmt.Errorf("put %q failed: %w", v.ObjectName(true), err)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Done
	//||------------------------------------------------------------------------------------------------||
	return nil
}
