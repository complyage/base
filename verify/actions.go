package verify

//||------------------------------------------------------------------------------------------------||
//|| Import
//||------------------------------------------------------------------------------------------------||

import (
	"encoding/json"
	"errors"
	"fmt"
	"time"

	"github.com/google/uuid"
	"github.com/ralphferrara/aria/app"
	"github.com/ralphferrara/aria/db"
	"github.com/ralphferrara/aria/storage"
)

//||------------------------------------------------------------------------------------------------||
//|| Create a Verification
//||------------------------------------------------------------------------------------------------||

func Create(dataType DataType, fidAccount int64, s *storage.Storage, d *db.GormWrapper, privateKey string, publicKey string) (Verification, error) {
	LogInfo("Verify: Init Verification")
	//||------------------------------------------------------------------------------------------------||
	//|| Start a Verification
	//||------------------------------------------------------------------------------------------------||
	vUUID := uuid.NewString()
	//||------------------------------------------------------------------------------------------------||
	//|| Create a Verification
	//||------------------------------------------------------------------------------------------------||
	verification := Verification{
		FidAccount: fidAccount,
		Keys: PrivatePublic{
			Private: privateKey,
			Public:  publicKey,
		},
		CanReset:      false,
		ResetAttempts: 0,
		Status:        STATUSES.Pending,
		UUID:          vUUID,
		Type:          dataType,
		Timestamp:     time.Now().UTC(),
		Storage:       *s,
		Database:      d,
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Updated
	//||------------------------------------------------------------------------------------------------||
	verification.Updated()
	//||------------------------------------------------------------------------------------------------||
	//|| Identity
	//||------------------------------------------------------------------------------------------------||
	verification.DatabaseLoadIdentity()
	//||------------------------------------------------------------------------------------------------||
	//|| Steps
	//||------------------------------------------------------------------------------------------------||
	verification.StepsInit()
	//||------------------------------------------------------------------------------------------------||
	//|| Create a Verification
	//||------------------------------------------------------------------------------------------------||
	verification.TwoFactorInit()
	//||------------------------------------------------------------------------------------------------||
	//|| Create the Public Transaction
	//||------------------------------------------------------------------------------------------------||
	verification.TransactionPublicInit()
	//||------------------------------------------------------------------------------------------------||
	//|| Create the Encrypted Data
	//||------------------------------------------------------------------------------------------------||
	verification.EncryptedInit()
	//||------------------------------------------------------------------------------------------------||
	//|| Create a Verification
	//||------------------------------------------------------------------------------------------------||
	verification.DatabaseSaveInsert()
	verification.Save()
	verification.SaveEncrypted()
	//||------------------------------------------------------------------------------------------------||
	//|| Create a Verification
	//||------------------------------------------------------------------------------------------------||
	return verification, nil
}

//||------------------------------------------------------------------------------------------------||
//|| Load: load a Verification from storage by UUID
//||------------------------------------------------------------------------------------------------||

func Load(d *db.GormWrapper, s *storage.Storage, uuid string, privateKey string, publicKey string) (Verification, error) {
	//||------------------------------------------------------------------------------------------------||
	//|| Validate
	//||------------------------------------------------------------------------------------------------||
	if uuid == "" {
		return Verification{}, fmt.Errorf("uuid is empty")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| V
	//||------------------------------------------------------------------------------------------------||
	v := Verification{}
	v.UUID = uuid
	//||------------------------------------------------------------------------------------------------||
	//|| Fetch Verification JSON
	//||------------------------------------------------------------------------------------------------||
	data, err := s.Get(v.ObjectName(false))
	if err != nil {
		return Verification{}, fmt.Errorf("get %q failed: %w", v.ObjectName(false), err)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Unmarshal
	//||------------------------------------------------------------------------------------------------||
	if err := json.Unmarshal(data, &v); err != nil {
		return Verification{}, fmt.Errorf("unmarshal %q failed: %w", v.ObjectName(false), err)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Storage
	//||------------------------------------------------------------------------------------------------||
	v.Database = d
	v.Storage = *s
	v.Keys = PrivatePublic{
		Private: privateKey,
		Public:  publicKey,
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Done
	//||------------------------------------------------------------------------------------------------||
	return v, nil
}

//||------------------------------------------------------------------------------------------------||
//|| Load: load a Verification from storage by UUID
//||------------------------------------------------------------------------------------------------||

func AgentLoad(d *db.GormWrapper, s *storage.Storage, uuid string, vType DataType) (Verification, error) {
	//||------------------------------------------------------------------------------------------------||
	//|| Validate
	//||------------------------------------------------------------------------------------------------||
	if uuid == "" {
		return Verification{}, app.Err("verify").Error("UUID_EMPTY")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| V
	//||------------------------------------------------------------------------------------------------||
	v := Verification{}
	v.UUID = uuid
	//||------------------------------------------------------------------------------------------------||
	//|| Fetch Verification JSON
	//||------------------------------------------------------------------------------------------------||
	data, err := s.Get(v.ObjectName(false))
	if err != nil {
		fmt.Println("Error fetching verification:", v.ObjectName(false), err)
		vErr := app.Err("verify").Get("RECORD_NOT_FOUND")
		verifyRecord := panicReject(uuid, vType, vErr)
		return verifyRecord, errors.New(vErr.Message)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Unmarshal
	//||------------------------------------------------------------------------------------------------||
	if err := json.Unmarshal(data, &v); err != nil {
		fmt.Println("Error unmarshaling verification:", v.ObjectName(false), err)
		vErr := app.Err("verify").Get("RECORD_CORRUPT")
		verifyRecord := panicReject(uuid, vType, vErr)
		return verifyRecord, errors.New(vErr.Message)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Storage
	//||------------------------------------------------------------------------------------------------||
	v.Database = d
	v.Storage = *s
	//||------------------------------------------------------------------------------------------------||
	//|| Done
	//||------------------------------------------------------------------------------------------------||
	return v, nil
}
