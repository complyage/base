package enforce

import (
	"net/http"
	"time"

	"github.com/ralphferrara/aria/app"
	"github.com/ralphferrara/aria/base/random"
)

//||------------------------------------------------------------------------------------------------||
//|| Get the Saved Private Key
//||------------------------------------------------------------------------------------------------||

func GetStoredPrivateKey(r *http.Request) string {
	//||------------------------------------------------------------------------------------------------||
	//|| Get the Saved Private Key Cookie
	//||------------------------------------------------------------------------------------------------||
	pookie, err := r.Cookie("private")
	if err != nil || pookie.Value == "" {
		return ""
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Fetch from Redis
	//||------------------------------------------------------------------------------------------------||
	private, err := app.CacheRedis["ouath"].Get("private:" + pookie.Value)
	if err != nil {
		return ""
	}
	return private
}

//||------------------------------------------------------------------------------------------------||
//|| Store Private Key
//||------------------------------------------------------------------------------------------------||

func StorePrivateKey(w http.ResponseWriter, private string, seconds int) (string, error) {
	//||------------------------------------------------------------------------------------------------||
	//|| Generate a Random Token
	//||------------------------------------------------------------------------------------------------||
	pookie := random.RandomString(32)
	//||------------------------------------------------------------------------------------------------||
	//|| Store in Redis with TTL
	//||------------------------------------------------------------------------------------------------||
	err := app.CacheRedis["oauth"].Set("private:"+pookie, private, time.Duration(seconds)*time.Second)
	if err != nil {
		return "", err
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Save the Cookie to Browser
	//||------------------------------------------------------------------------------------------------||
	http.SetCookie(w, &http.Cookie{
		Name:     "private",
		Value:    pookie,
		Path:     "/",
		HttpOnly: true,
		Secure:   true,
		MaxAge:   seconds,
	})
	//||------------------------------------------------------------------------------------------------||
	//|| Return Token
	//||------------------------------------------------------------------------------------------------||
	return pookie, nil
}
