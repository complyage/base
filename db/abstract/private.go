package abstract

import (
	"net/http"
	"time"

	"github.com/ralphferrara/aria/app"
	"github.com/ralphferrara/aria/base/random"
)

//||------------------------------------------------------------------------------------------------||
//|| StoredPrivateKey
//||------------------------------------------------------------------------------------------------||

func SetPrivateKey(r *http.Request, privateKey string, minutes int) (string, error) {
	//||------------------------------------------------------------------------------------------------||
	//|| Cookie
	//||------------------------------------------------------------------------------------------------||

	token := random.RandomString(64)

	//||------------------------------------------------------------------------------------------------||
	//|| Get from Redis
	//||------------------------------------------------------------------------------------------------||

	err := app.CacheRedis["auth"].Set("private:"+token, privateKey, time.Duration(minutes)*time.Minute)
	if err != nil {
		return "", app.Err("API").Error("MISSING_PRIVATE")
	}

	//||------------------------------------------------------------------------------------------------||
	//|| Mismatch
	//||------------------------------------------------------------------------------------------------||

	return token, nil

}

//||------------------------------------------------------------------------------------------------||
//|| StoredPrivateKey
//||------------------------------------------------------------------------------------------------||

func StoredPrivateKey(r *http.Request) (string, error) {

	//||------------------------------------------------------------------------------------------------||
	//|| Cookie
	//||------------------------------------------------------------------------------------------------||

	cookie, err := r.Cookie("private")
	if err != nil || cookie.Value == "" {
		return "", app.Err("API").Error("MISSING_COOKIE")
	}

	//||------------------------------------------------------------------------------------------------||
	//|| Get from Redis
	//||------------------------------------------------------------------------------------------------||

	privateKey, err := app.CacheRedis["auth"].Get("private:" + cookie.Value)
	if err != nil || privateKey == "" {
		return "", app.Err("API").Error("MISSING_PRIVATE")
	}

	//||------------------------------------------------------------------------------------------------||
	//|| Mismatch
	//||------------------------------------------------------------------------------------------------||

	return privateKey, nil

}
